<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>かんたん会計（試作）</title>
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #222;
      --muted: #666;
      --accent: #3b82f6;
      --danger: #ef4444;
      --ok: #16a34a;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; display: grid; gap: 16px; grid-template-columns: 1.2fr 1fr; }
    header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; }
    h1 { font-size: 22px; margin: 0; }
    .card { background: var(--card); border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.06); padding: 16px; }
    .items { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .btn { display: flex; flex-direction: column; gap: 6px; align-items: center; justify-content: center; border: 2px solid transparent; border-radius: 16px; padding: 16px; font-weight: 700; font-size: 20px; cursor: pointer; background: #eef2ff; transition: transform .03s ease, filter .15s; user-select: none; }
    .btn:active { transform: translateY(1px) scale(0.99); }
    .btn .price { font-size: 16px; font-weight: 600; color: var(--muted); }
    .right { display: grid; gap: 16px; grid-template-rows: auto 1fr auto; }
    .list { max-height: 380px; overflow: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; text-align: left; font-size: 16px; }
    thead th { position: sticky; top: 0; background: #f0f3ff; }
    tbody tr:nth-child(odd) { background: #fafbff; }
    .qtyCtrl { display: inline-flex; gap: 6px; align-items: center; }
    .pill { border-radius: 999px; padding: 4px 10px; border: 1px solid #e5e7eb; background: #fff; font-size: 14px; }
    .pill.btn { font-size: 14px; padding: 4px 10px; background: #eef2ff; }
    .footer { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
    .total { font-size: 28px; font-weight: 900; letter-spacing: .5px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    input[type="number"], input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid #e5e7eb; font-size: 18px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .actionBtn { padding: 10px 14px; border-radius: 12px; border: 0; cursor: pointer; font-weight: 700; }
    .primary { background: var(--accent); color: #fff; }
    .danger { background: var(--danger); color: #fff; }
    .ok { background: var(--ok); color: #fff; }
    .muted { background: #e5e7eb; }
    .badge { font-size: 12px; background: #f1f5f9; border: 1px dashed #cbd5e1; padding: 4px 8px; border-radius: 999px; color: #334155; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .big { font-size: 36px; font-weight: 900; }
    .stickyBar { position: sticky; bottom: 0; background: var(--card); padding-top: 8px; }
    .small { font-size: 12px; color: var(--muted); }

    @media (max-width: 900px) { .container { grid-template-columns: 1fr; } .items { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 480px) { .items { grid-template-columns: 1fr; } .btn { font-size: 18px; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>かんたん会計（試作）<span class="badge" id="syncStatus">オフライン保存中</span></h1>
      <div class="actions">
        <button class="actionBtn muted" id="manageItems">商品編集</button>
        <button class="actionBtn primary" id="saveLayout">設定保存</button>
        <button class="actionBtn ok" id="syncExcel">Excelに同期</button>
      </div>
    </header>

    <!-- 左：商品ボタン -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div class="small">タップで追加 / 長押しで数量入力</div>
        </div>
        <div class="small">今日の日付: <span id="today"></span></div>
      </div>
      <div class="items" id="items"></div>
    </section>

    <!-- 右：会計エリア -->
    <section class="right">
      <div class="card list">
        <table>
          <thead>
            <tr>
              <th style="width:40%">品名</th>
              <th>単価</th>
              <th>数量</th>
              <th>小計</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="cartBody"></tbody>
        </table>
      </div>

      <div class="card">
        <div class="row">
          <div class="total">合計：<span class="big" id="grandTotal">¥0</span></div>
          <div class="actions" style="justify-content:flex-end">
            <button class="actionBtn muted" id="undoBtn">1つ戻す</button>
            <button class="actionBtn danger" id="clearBtn">クリア</button>
          </div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div>
            <label class="small">いただいた金額</label>
            <input type="number" id="paidInput" inputmode="numeric" placeholder="0" />
          </div>
          <div>
            <label class="small">お釣り</label>
            <input type="text" id="changeOut" readonly />
          </div>
        </div>
      </div>

      <div class="card stickyBar">
        <div class="row">
          <div>
            <div class="small">売上個数（本セッション）</div>
            <div id="salesCounts" style="display:flex;gap:8px;flex-wrap:wrap"></div>
          </div>
          <div class="actions" style="justify-content:flex-end">
            <button class="actionBtn ok" id="checkoutBtn">会計確定</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    /**********************
     * 初期データ（好きに編集）
     **********************/
    const defaultItems = [
      { id: 'A', name: 'A', price: 100 },
      { id: 'B', name: 'B', price: 200 },
      { id: 'C', name: 'C', price: 250 },
    ];

    const state = {
      items: load('items') || defaultItems,
      cart: [],
      history: [], // undo用
      sales: load('sales') || {}, // {id: 累計個数}
    };

    // ユーティリティ
    function save(key, val){ localStorage.setItem('pos_'+key, JSON.stringify(val)); }
    function load(key){ try { return JSON.parse(localStorage.getItem('pos_'+key)); } catch(e){ return null; } }
    function yen(n){ return '¥' + (n||0).toLocaleString('ja-JP'); }

    // 今日の日付表示
    document.getElementById('today').textContent = new Date().toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit'});

    // 商品ボタン描画
    function renderItems(){
      const wrap = document.getElementById('items');
      wrap.innerHTML = '';
      state.items.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.innerHTML = `<div>${item.name}</div><div class="price">${yen(item.price)}</div>`;
        btn.addEventListener('click', () => addToCart(item.id, 1));
        // 長押しで数量指定
        let pressTimer;
        btn.addEventListener('mousedown', () => {
          pressTimer = setTimeout(() => {
            const qty = parseInt(prompt(`${item.name} の数量を入力`, '1')||'0',10);
            if(qty>0) addToCart(item.id, qty);
          }, 550);
        });
        ['mouseup','mouseleave'].forEach(ev=>btn.addEventListener(ev, ()=>clearTimeout(pressTimer)));
        wrap.appendChild(btn);
      });
      renderSalesCounts();
    }

    function addToCart(itemId, qty=1){
      const item = state.items.find(i=>i.id===itemId);
      if(!item) return;
      const row = state.cart.find(r=>r.id===itemId);
      if(row){ row.qty += qty; }
      else { state.cart.push({ id:item.id, name:item.name, price:item.price, qty }); }
      state.history.push({type:'add', id:itemId, qty});
      renderCart();
    }

    function removeOne(itemId){
      const row = state.cart.find(r=>r.id===itemId);
      if(!row) return;
      row.qty -= 1;
      if(row.qty<=0){ state.cart = state.cart.filter(r=>r.id!==itemId); }
      state.history.push({type:'remove', id:itemId, qty:1});
      renderCart();
    }

    function deleteLine(itemId){
      const row = state.cart.find(r=>r.id===itemId);
      if(!row) return;
      state.cart = state.cart.filter(r=>r.id!==itemId);
      state.history.push({type:'delete', id:itemId, qty:row.qty});
      renderCart();
    }

    function computeTotal(){
      return state.cart.reduce((s,r)=>s+r.price*r.qty,0);
    }

    function renderCart(){
      const body = document.getElementById('cartBody');
      body.innerHTML='';
      state.cart.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${yen(r.price)}</td>
          <td>
            <div class="qtyCtrl">
              <button class="pill btn" onclick="changeQty('${r.id}', -1)">－</button>
              <span class="pill">${r.qty}</span>
              <button class="pill btn" onclick="changeQty('${r.id}', 1)">＋</button>
            </div>
          </td>
          <td>${yen(r.price*r.qty)}</td>
          <td><button class="pill btn" onclick="deleteLine('${r.id}')">削除</button></td>`;
        body.appendChild(tr);
      });
      const total = computeTotal();
      document.getElementById('grandTotal').textContent = yen(total);
      updateChange();
    }

    window.changeQty = (id, diff) =>{
      const row = state.cart.find(r=>r.id===id);
      if(!row) return;
      row.qty += diff;
      if(row.qty<=0){ state.cart = state.cart.filter(r=>r.id!==id); }
      state.history.push({type: diff>0?'add':'remove', id, qty: Math.abs(diff)});
      renderCart();
    }

    // お釣り計算
    const paidInput = document.getElementById('paidInput');
    const changeOut = document.getElementById('changeOut');
    paidInput.addEventListener('input', updateChange);
    function updateChange(){
      const paid = parseInt(paidInput.value||'0',10);
      const change = paid - computeTotal();
      changeOut.value = change>=0 ? yen(change) : '不足：'+yen(-change);
    }

    // Undo / クリア
    document.getElementById('undoBtn').addEventListener('click', ()=>{
      const last = state.history.pop();
      if(!last) return;
      if(last.type==='add'){
        changeQty(last.id, -last.qty);
        state.history.pop(); // changeQtyがpushした履歴を消す
      } else if(last.type==='remove'){
        changeQty(last.id, last.qty);
        state.history.pop();
      } else if(last.type==='delete'){
        const item = state.items.find(i=>i.id===last.id);
        state.cart.push({ id:item.id, name:item.name, price:item.price, qty:last.qty });
        renderCart();
      }
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      if(confirm('カートを空にしますか？')){ state.cart=[]; state.history=[]; renderCart(); }
    });

    // 会計確定 → 売上個数に反映
    document.getElementById('checkoutBtn').addEventListener('click', ()=>{
      if(state.cart.length===0) return alert('カートが空です');
      const paid = parseInt(paidInput.value||'0',10);
      const total = computeTotal();
      if(paid < total) return alert('お支払いが不足しています');

      // 累計に反映
      state.cart.forEach(r=>{
        state.sales[r.id] = (state.sales[r.id]||0) + r.qty;
      });
      save('sales', state.sales);
      renderSalesCounts();

      // ジャーナル（あとでExcel同期に使えるレコード）
      const journal = load('journal') || [];
      journal.push({
        ts: new Date().toISOString(),
        lines: state.cart.map(r=>({ id:r.id, name:r.name, price:r.price, qty:r.qty, subtotal: r.price*r.qty })),
        total,
        paid,
        change: paid-total
      });
      save('journal', journal);

      // リセット
      state.cart=[]; state.history=[]; paidInput.value=''; updateChange(); renderCart();
      alert('会計を記録しました\n（ローカル保存。Excel同期ボタンで送信できます）');
    });

    function renderSalesCounts(){
      const wrap = document.getElementById('salesCounts');
      wrap.innerHTML='';
      state.items.forEach(i=>{
        const n = state.sales[i.id]||0;
        const el = document.createElement('span');
        el.className='pill';
        el.textContent = `${i.name}: ${n}個`;
        wrap.appendChild(el);
      });
    }

    // 商品編集（超簡易）
    document.getElementById('manageItems').addEventListener('click', ()=>{
      const json = prompt('商品リストをJSONで編集\n例: [{"id":"A","name":"A","price":100},...]', JSON.stringify(state.items, null, 2));
      if(!json) return;
      try{
        const arr = JSON.parse(json);
        if(!Array.isArray(arr)) throw new Error('配列ではありません');
        // 簡易バリデーション
        arr.forEach(x=>{ if(!x.id||!x.name||typeof x.price!=="number") throw new Error('id/name/price が不正'); });
        state.items = arr;
        save('items', state.items);
        renderItems(); renderCart();
      }catch(e){ alert('エラー: '+e.message); }
    });

    document.getElementById('saveLayout').addEventListener('click', ()=>{
      save('items', state.items);
      save('sales', state.sales);
      alert('設定を保存しました（この端末のブラウザに保存）');
    });

    /**********************
     * Excel同期（MS Graph想定）
     * 実装メモ：
     * - SharePoint/OneDrive 上の Excel にテーブル（例: SalesJournal）を作成
     *   列: Timestamp, ItemId, ItemName, Price, Qty, Subtotal, Total, Paid, Change
     * - 下記 uploadToExcel() を MSAL + Graph API で実装
     **********************/
    document.getElementById('syncExcel').addEventListener('click', async ()=>{
      const journal = load('journal') || [];
      if(journal.length===0) return alert('送信するデータがありません');
      document.getElementById('syncStatus').textContent='同期中…';
      try{
        const uploaded = await uploadToExcel(journal);
        if(uploaded){
          save('journal', []); // 成功したら送信済みに
          document.getElementById('syncStatus').textContent='同期済み';
          alert('Excelに同期しました');
        } else {
          document.getElementById('syncStatus').textContent='失敗';
        }
      }catch(err){
        console.error(err);
        document.getElementById('syncStatus').textContent='エラー';
        alert('同期でエラーが発生しました（コンソール参照）');
      }
    });

    async function uploadToExcel(journal){
      // ★ここを実装★
      // 1) MSAL (msal-browser) を読み込んでサインイン
      // 2) Graph トークン取得
      // 3) /drives/{drive-id}/items/{item-id}/workbook/tables/{name}/rows/add へ POST
      //    { values: [ [Timestamp, ItemId, ItemName, Price, Qty, Subtotal, Total, Paid, Change], ...] }
      // セキュリティ上、Node/Cloudflare Worker 等のサーバ中継を推奨（Sites.ReadWrite.All など権限管理のため）
      console.warn('uploadToExcel は未実装のダミー。Graph設定後に実装してください。');
      return false;
    }

    // 初期描画
    renderItems();
    renderCart();
  </script>
</body>
</html>
